---
# Bootstrap playbook for new Ubuntu servers
# This playbook configures a fresh Ubuntu server with common settings,
# security hardening, and essential packages

- name: Bootstrap Ubuntu Servers
  hosts: ubuntu_servers
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: always

    - name: Display server information
      debug:
        msg: "Bootstrapping {{ inventory_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})"
      tags: always

  roles:
    - role: common
      tags: common

    - role: security
      tags: security

    - role: updates
      tags: updates

  post_tasks:
    - name: Display completion message
      debug:
        msg: "Bootstrap completed successfully for {{ inventory_hostname }}"
      tags: always

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      tags: always

    - name: Notify if reboot required
      debug:
        msg: "WARNING: {{ inventory_hostname }} requires a reboot!"
      when: reboot_required_file.stat.exists
      tags: always
