---
- name: Verify security configuration
  hosts: all
  become: true
  gather_facts: false

  tasks:
    # SSH Configuration Tests
    - name: Verify SSH - PermitRootLogin is disabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
      check_mode: yes
      register: ssh_root_login
      failed_when: ssh_root_login.changed

    - name: Verify SSH - PasswordAuthentication is disabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
      check_mode: yes
      register: ssh_password_auth
      failed_when: ssh_password_auth.changed

    - name: Verify SSH - PubkeyAuthentication is enabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PubkeyAuthentication'
        line: 'PubkeyAuthentication yes'
        state: present
      check_mode: yes
      register: ssh_pubkey_auth
      failed_when: ssh_pubkey_auth.changed

    - name: Verify SSH - MaxAuthTries is limited
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^MaxAuthTries'
        line: 'MaxAuthTries 3'
        state: present
      check_mode: yes
      register: ssh_max_auth
      failed_when: ssh_max_auth.changed

    - name: Verify SSH - X11Forwarding is disabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^X11Forwarding'
        line: 'X11Forwarding no'
        state: present
      check_mode: yes
      register: ssh_x11
      failed_when: ssh_x11.changed

    # UFW Firewall Tests
    - name: Verify UFW is installed
      package:
        name: ufw
        state: present
      check_mode: yes
      register: ufw_installed
      failed_when: ufw_installed.changed

    - name: Verify UFW is enabled
      command: ufw status
      register: ufw_status
      changed_when: false
      failed_when: "'Status: active' not in ufw_status.stdout"

    - name: Verify UFW default incoming is deny
      command: ufw status verbose
      register: ufw_verbose
      changed_when: false
      failed_when: "'Default: deny (incoming)' not in ufw_verbose.stdout"

    - name: Verify UFW default outgoing is allow
      command: ufw status verbose
      register: ufw_outgoing
      changed_when: false
      failed_when: "'allow (outgoing)' not in ufw_outgoing.stdout"

    - name: Verify SSH port is allowed through UFW
      command: ufw status
      register: ufw_ssh
      changed_when: false
      failed_when: "'22/tcp' not in ufw_ssh.stdout"

    # fail2ban Tests
    - name: Verify fail2ban is installed
      package:
        name: fail2ban
        state: present
      check_mode: yes
      register: fail2ban_installed
      failed_when: fail2ban_installed.changed

    - name: Verify fail2ban service is enabled
      service:
        name: fail2ban
        enabled: yes
      check_mode: yes
      register: fail2ban_enabled
      failed_when: fail2ban_enabled.changed

    - name: Verify fail2ban jail.local exists
      stat:
        path: /etc/fail2ban/jail.local
      register: jail_local
      failed_when: not jail_local.stat.exists

    - name: Verify fail2ban sshd jail is configured
      lineinfile:
        path: /etc/fail2ban/jail.local
        regexp: '^\[sshd\]'
        line: '[sshd]'
        state: present
      check_mode: yes
      register: fail2ban_sshd
      failed_when: fail2ban_sshd.changed

    # Unattended Upgrades Tests
    - name: Verify unattended-upgrades is installed
      package:
        name: unattended-upgrades
        state: present
      check_mode: yes
      register: unattended_installed
      failed_when: unattended_installed.changed

    - name: Verify unattended-upgrades config exists
      stat:
        path: /etc/apt/apt.conf.d/50unattended-upgrades
      register: unattended_config
      failed_when: not unattended_config.stat.exists

    - name: Verify auto-upgrades config exists
      stat:
        path: /etc/apt/apt.conf.d/20auto-upgrades
      register: auto_upgrades_config
      failed_when: not auto_upgrades_config.stat.exists

    # Sysctl Security Parameters Tests
    - name: Verify sysctl - ICMP broadcast ignored
      command: sysctl net.ipv4.icmp_echo_ignore_broadcasts
      register: sysctl_icmp
      changed_when: false
      failed_when: "'= 1' not in sysctl_icmp.stdout"

    - name: Verify sysctl - TCP syncookies enabled
      command: sysctl net.ipv4.tcp_syncookies
      register: sysctl_syncookies
      changed_when: false
      failed_when: "'= 1' not in sysctl_syncookies.stdout"

    - name: Verify sysctl - Accept redirects disabled
      command: sysctl net.ipv4.conf.all.accept_redirects
      register: sysctl_redirects
      changed_when: false
      failed_when: "'= 0' not in sysctl_redirects.stdout"

    - name: Verify sysctl - Source routing disabled
      command: sysctl net.ipv4.conf.all.accept_source_route
      register: sysctl_source_route
      changed_when: false
      failed_when: "'= 0' not in sysctl_source_route.stdout"

    - name: Display verification summary
      debug:
        msg: "All security verification tests passed successfully!"
