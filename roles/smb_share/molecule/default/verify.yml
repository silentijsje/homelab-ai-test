---
- name: Verify SMB share configuration
  hosts: all
  become: true
  gather_facts: false

  tasks:
    # Samba Installation Tests
    - name: Verify Samba packages are installed
      package:
        name: "{{ item }}"
        state: present
      check_mode: yes
      register: samba_packages
      failed_when: samba_packages.changed
      loop:
        - samba
        - samba-common
        - samba-common-bin

    - name: Verify Samba service is enabled
      service:
        name: smbd
        enabled: yes
      check_mode: yes
      register: smbd_enabled
      failed_when: smbd_enabled.changed

    # User/Group Tests for testshare
    - name: Verify smbtest group exists with correct GID
      getent:
        database: group
        key: smbtest
      register: smbtest_group

    - name: Assert smbtest group has correct GID
      assert:
        that:
          - smbtest_group.ansible_facts.getent_group.smbtest[1] == "3001"
        fail_msg: "smbtest group GID is not 3001"

    - name: Verify smbtest user exists with correct UID
      getent:
        database: passwd
        key: smbtest
      register: smbtest_user

    - name: Assert smbtest user has correct UID
      assert:
        that:
          - smbtest_user.ansible_facts.getent_passwd.smbtest[1] == "3001"
        fail_msg: "smbtest user UID is not 3001"

    - name: Verify smbtest user has nologin shell
      assert:
        that:
          - "'/usr/sbin/nologin' in smbtest_user.ansible_facts.getent_passwd.smbtest[5]"
        fail_msg: "smbtest user does not have nologin shell"

    # User/Group Tests for readonly share
    - name: Verify smbro group exists with correct GID
      getent:
        database: group
        key: smbro
      register: smbro_group

    - name: Assert smbro group has correct GID
      assert:
        that:
          - smbro_group.ansible_facts.getent_group.smbro[1] == "3002"
        fail_msg: "smbro group GID is not 3002"

    - name: Verify smbro user exists with correct UID
      getent:
        database: passwd
        key: smbro
      register: smbro_user

    - name: Assert smbro user has correct UID
      assert:
        that:
          - smbro_user.ansible_facts.getent_passwd.smbro[1] == "3002"
        fail_msg: "smbro user UID is not 3002"

    # Share Directory Tests
    - name: Verify testshare directory exists
      stat:
        path: /srv/samba/testshare
      register: testshare_dir
      failed_when: not testshare_dir.stat.exists or not testshare_dir.stat.isdir

    - name: Verify testshare directory ownership
      stat:
        path: /srv/samba/testshare
      register: testshare_stat

    - name: Assert testshare directory has correct ownership
      assert:
        that:
          - testshare_stat.stat.uid == 3001
          - testshare_stat.stat.gid == 3001
        fail_msg: "testshare directory does not have correct ownership"

    - name: Verify readonly directory exists
      stat:
        path: /srv/samba/readonly
      register: readonly_dir
      failed_when: not readonly_dir.stat.exists or not readonly_dir.stat.isdir

    - name: Verify readonly directory ownership
      stat:
        path: /srv/samba/readonly
      register: readonly_stat

    - name: Assert readonly directory has correct ownership
      assert:
        that:
          - readonly_stat.stat.uid == 3002
          - readonly_stat.stat.gid == 3002
        fail_msg: "readonly directory does not have correct ownership"

    # Samba Configuration Tests
    - name: Verify smb.conf exists
      stat:
        path: /etc/samba/smb.conf
      register: smb_conf
      failed_when: not smb_conf.stat.exists

    - name: Verify smb.conf is valid
      command: testparm -s /etc/samba/smb.conf
      register: testparm_result
      changed_when: false
      failed_when: testparm_result.rc != 0

    - name: Verify workgroup is configured
      command: testparm -s --parameter-name=workgroup
      register: workgroup_check
      changed_when: false
      failed_when: "'TESTGROUP' not in workgroup_check.stdout"

    - name: Read smb.conf for share verification
      slurp:
        src: /etc/samba/smb.conf
      register: smb_conf_content

    - name: Decode smb.conf content
      set_fact:
        smb_conf_decoded: "{{ smb_conf_content.content | b64decode }}"

    - name: Verify testshare section exists
      assert:
        that:
          - "'[testshare]' in smb_conf_decoded"
        fail_msg: "testshare section not found in smb.conf"

    - name: Verify readonly section exists
      assert:
        that:
          - "'[readonly]' in smb_conf_decoded"
        fail_msg: "readonly section not found in smb.conf"

    - name: Verify testshare is writable
      assert:
        that:
          - "'writable = yes' in smb_conf_decoded or 'read only = no' in smb_conf_decoded"
        fail_msg: "testshare is not configured as writable"

    # Samba User Tests
    - name: Verify smbtest is a valid Samba user
      command: pdbedit -L
      register: pdbedit_list
      changed_when: false
      failed_when: "'smbtest' not in pdbedit_list.stdout"

    - name: Verify smbro is a valid Samba user
      command: pdbedit -L
      register: pdbedit_list_ro
      changed_when: false
      failed_when: "'smbro' not in pdbedit_list_ro.stdout"

    # Idempotency Indicator
    - name: Display verification summary
      debug:
        msg: "All SMB share verification tests passed successfully!"
